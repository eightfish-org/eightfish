<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>EightFish Book</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="features.html"><strong aria-hidden="true">2.</strong> Features</a></li><li class="chapter-item expanded "><a href="get_started.html"><strong aria-hidden="true">3.</strong> Get Started</a></li><li class="chapter-item expanded "><a href="tech_stack.html"><strong aria-hidden="true">4.</strong> Tech Stack</a></li><li class="chapter-item expanded "><a href="examples.html"><strong aria-hidden="true">5.</strong> Examples</a></li><li class="chapter-item expanded "><a href="anatomy.html"><strong aria-hidden="true">6.</strong> Anatomy</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="mapping.html"><strong aria-hidden="true">6.1.</strong> Core Mapping</a></li><li class="chapter-item expanded "><a href="node_arch.html"><strong aria-hidden="true">6.2.</strong> Node Architecture</a></li><li class="chapter-item expanded "><a href="workflows.html"><strong aria-hidden="true">6.3.</strong> Workflows</a></li></ol></li><li class="chapter-item expanded "><a href="mvc.html"><strong aria-hidden="true">7.</strong> MVC Framework</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="mvc_onchain_service.html"><strong aria-hidden="true">7.1.</strong> Limitations</a></li></ol></li><li class="chapter-item expanded "><a href="tinyorm.html"><strong aria-hidden="true">8.</strong> TinyORM</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="crud.html"><strong aria-hidden="true">8.1.</strong> CRUD</a></li><li class="chapter-item expanded "><a href="complex_queries.html"><strong aria-hidden="true">8.2.</strong> Complex Queries</a></li><li class="chapter-item expanded "><a href="sql_limits.html"><strong aria-hidden="true">8.3.</strong> Limitations</a></li></ol></li><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">9.</strong> Cryptographic Account</a></li><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">10.</strong> Application Topology</a></li><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">11.</strong> Demo: GUTP and its apps</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">11.1.</strong> How GUTP Implemented</a></li><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">11.2.</strong> Discux</a></li><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">11.3.</strong> Meblog</a></li><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">11.4.</strong> Talkit</a></li></ol></li><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">12.</strong> Languages</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">12.1.</strong> Rust SDK</a></li><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">12.2.</strong> Go SDK</a></li><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">12.3.</strong> JavaScript SDK</a></li></ol></li><li class="chapter-item expanded "><a href="openweb.html"><strong aria-hidden="true">13.</strong> The OpenWeb Ecosystem</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">EightFish Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <br/>
<p align="center">
<a href=" " target="_blank">
<img src="https://raw.githubusercontent.com/eightfish-org/eightfish_assets/master/ef_logo_lightbg_wo_char.png" width="240" alt="eightfish logo">
</a >
</p >
<br/>
<h1 id="eightfish"><a class="header" href="#eightfish">EightFish</a></h1>
<p>What is EightFish?</p>
<p>EightFish is a Web MVC framework to deveop decentralized application.</p>
<p>Deeply, EightFish is a development framework (maybe the first one) for the Open Data Application (ODA), implementing the Open Data Application Model (ODAM). You can think of ODA is a type of data-kind decentralized application of Web3. The theory of ODA and ODAM is located <a href="https://medium.com/@daogangtang/the-road-to-open-web-b684879a5571">here</a>. In a short description: EightFish powers ODAs, ODAs constitute the OpenWeb, which is a subset of Web3.</p>
<p>EightFish makes devs to develop a decentralized application in Web2 development style, rather than the smart contract style. Unlike the smart contract blockchain tech stack most DApps adopt, EightFish makes your own network, a sovereign network which doesn't rely on any other Web3 layers or services.</p>
<p>By some elaberate designs, EightFish reaches the experiences of Web2/Internet web development, but for the OpenWeb/Web3 decentralized application.</p>
<p>NOTICE: EightFish itself is not a service/platform/serverless/layer, it is just a dev framework tool.</p>
<h2 id="license"><a class="header" href="#license">License</a></h2>
<p>GPLv3.0</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="features"><a class="header" href="#features">Features</a></h1>
<p>EightFish has following highlights:</p>
<ol>
<li>High performance. EightFish put user experience as the first level target, it has been optimized on all aspects to achieve this taget.</li>
<li>Low latency. EightFish makes it to get consensus result in upto 2 seconds.</li>
<li>Fully on-chain actions. EightFish use blockchain to keep the openness of the data mandatory, all actions are related to on-chain storage or checking.</li>
<li>Powerful off-chain abilities. EightFish has a full-fledged off-chain worker outside of the blockchain node, it can perform general computation, although some limitations applied.</li>
<li>Powerful query ability. EightFish grants you the ability to use query statement of SQL out of box, which is far beyond the schemes supplied by current mainstream Web3 tech stack (e.g. Eth + The Graph). The query result will be returned in dozens of ms, after the internal validation. </li>
<li>An easy Web CRUD interface for programmer. A traditional Web2 (or Internet) programmer would feel home at writing the code of an EightFish application, it's the same.</li>
<li>All in WebAssembly. All components are written in Rust, and compiled to WebAssembly to distributed and executed.</li>
</ol>
<p>In addtion, an EightFish App (or Open Data App) has following extra features:</p>
<ol start="2">
<li>An EightFish App will have a sovereign network for it.</li>
<li>No token (asset) on this app platform/network, thus NO xFi for the data on this platform, and NO token incentives for validators;</li>
<li>An EightFish App is just (or better as) a layer of low level data service, with no UI, no static asset files, no higher business logic in it. It needs some form of front services connected to it to provide direct business products (data aggregations, Web UI, Phone UI, etc.) for the end user;</li>
<li>One EightFish App/network holds one application protocol, one application protocol can hold multiple products for users. Different products are connected to the same backend data service, share the same dataset among all products.</li>
<li>An EightFish application/product supports both the Web2 style account via Oauth, and the Web3 style account via cryptographic algorithm.</li>
<li>On the side of user experience, if not told, you can barely recognize it as a Web3 application. Too good to ignore.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-get-started"><a class="header" href="#how-to-get-started">How to Get Started</a></h1>
<h2 id="create-a-new-project"><a class="header" href="#create-a-new-project">Create a new project</a></h2>
<p>From the template project of ef_example_simple_standalone.</p>
<pre><code>git clone https://github.com/eightfish-org/ef_example_simple_standalone
</code></pre>
<p>Modify this template and git config infomation. </p>
<h2 id="compile-this-repository"><a class="header" href="#compile-this-repository">Compile this repository</a></h2>
<pre><code>cd ef_example_simple_standalone
spin build
</code></pre>
<p>here we assumed that you have installed the spin binary and the Rust toolchain set. If you didn't, do it by:</p>
<pre><code># install rust at first, and add the following component
rustup target add wasm32-wasi

# download spin v1.3.0
cd /tmp 
curl -fsSL https://developer.fermyon.com/downloads/install.sh | bash -s -- -v v1.3.0
mv /tmp/spin ~/.cargo/bin/
</code></pre>
<h2 id="copy-the-spin-binary-to-current-directory"><a class="header" href="#copy-the-spin-binary-to-current-directory">Copy the spin binary to current directory</a></h2>
<pre><code>cp ~/.cargo/bin/spin .
</code></pre>
<h2 id="build-the-app-docker"><a class="header" href="#build-the-app-docker">Build the app docker</a></h2>
<pre><code>./build_app.sh
</code></pre>
<h2 id="run-docker-compose"><a class="header" href="#run-docker-compose">Run docker compose.</a></h2>
<pre><code>docker compose -f docker-compose-1node.yml up
</code></pre>
<p>after a while,</p>
<h2 id="test"><a class="header" href="#test">Test</a></h2>
<p>We use <code>hurl</code> as the client to do testing. You can install it by:</p>
<pre><code>cargo install hurl
</code></pre>
<p>And then,</p>
<pre><code>cd flow_tests

# create new artile row
hurl new_article.hurl

# it returns something like:
# {&quot;result&quot;:&quot;Ok&quot;,&quot;id&quot;:&quot;5wzxHoJnQd5QhbGcdKkesGiEwtUkynPY4JFrUrm9Us5q&quot;}

# copy the returned id and paste to the right place of the next command line to get this article
hurl --variable id=5wzxHoJnQd5QhbGcdKkesGiEwtUkynPY4JFrUrm9Us5q get_one_article.hurl

# it returns something like:
# [{&quot;id&quot;:&quot;5wzxHoJnQd5QhbGcdKkesGiEwtUkynPY4JFrUrm9Us5q&quot;,&quot;title&quot;:&quot;test111&quot;,&quot;content&quot;:&quot;this is the content of test111&quot;,&quot;authorname&quot;:&quot;mike tang&quot;}]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tech-stack"><a class="header" href="#tech-stack">Tech Stack</a></h1>
<p>EightFish is written in Rust overall. Thanks to the following technologies:</p>
<ul>
<li><a href="docs.substrate.io/">Substrate</a>. The subnode component is built using Substrate, the most powerful blockchain framework made by Parity.</li>
<li><a href="https://docs.rs/subxt/latest/subxt/">Subxt</a>. The subxtproxy is built using Subxt, the client RPC library of Substrate.</li>
<li><a href="https://www.fermyon.com/spin">Spin framework</a>. An innovative webassembly framework for the future of the cloud.</li>
<li>redis. No explanation.</li>
<li>postgres db. No explanation.</li>
</ul>
<h2 id="substrate"><a class="header" href="#substrate">Substrate</a></h2>
<p>The role of Substrate in EightFish.</p>
<ol>
<li>Used to record the incoming raw writing requests, bake them into blocks, like a log system</li>
<li>Used to sync runtime state among all EightFish nodes (Substrate network), further to coordinate the state of the SQL db among all nodes</li>
<li>Used to store the version of wasm code and make the code of spin worker upgrade forklessly </li>
<li>(not sure) Used to interoperate with other Substrate-based chains by leveraging existing pallets</li>
</ol>
<p>There is a great <a href="https://docs.google.com/presentation/d/1YIz5rv2R-P8gF-4vvAyHYb0rCGUrUUM0HEpB8ywIcfo/edit?usp=sharing">slide</a> to explain EightFish for Substrate developers.</p>
<h2 id="all-in-wasm"><a class="header" href="#all-in-wasm">All in Wasm</a></h2>
<p>Almost all EightFish components are compiled into webassembly to run, except for redis and postgres.</p>
<p>We believe that the wasm bytecode will be the standard format of software distribution in the future.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="examples"><a class="header" href="#examples">Examples</a></h1>
<p>There are some examples you can get to start on.</p>
<ul>
<li><a href="https://github.com/eightfish-org/ef_example_simple_standalone">Simple</a></li>
<li><a href="https://github.com/eightfish-org/ef_example_todo">TodoList</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="anatomy"><a class="header" href="#anatomy">Anatomy</a></h1>
<p>The simplest interface usually means the most complex innternal mechanism. Here we give the insights of the EightFish framework.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="core-mapping"><a class="header" href="#core-mapping">Core Mapping</a></h1>
<p>This picture illustrates the core mapping theory between off-chain sql db and the on-chain runtime storage.</p>
<p><img src="https://raw.githubusercontent.com/eightfish-org/eightfish_assets/master/mapping.png" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="arch-of-the-eightfish-node"><a class="header" href="#arch-of-the-eightfish-node">Arch of the EightFish Node</a></h1>
<p><img src="https://raw.githubusercontent.com/eightfish-org/eightfish_assets/master/node_arch.png" alt="" /></p>
<p>Explanation:</p>
<p>There are some components in an EightFish node.</p>
<ul>
<li>subnode: the blockchain node located inside of an EightFish node.</li>
<li>subxtproxy: the subnode rpc client used to connect the subnode with the spin worker.</li>
<li>redis: used as msg channels and data caches</li>
<li>postgres: used as the storage of raw data</li>
<li>http gate: used as the interface of http data service</li>
<li>spin worker: acts as the core business engine in EightFish workflow.</li>
<li>MVC: an easy engineering layer for programmer to write logic, in a style of Web CRUD.</li>
<li>Tiny ORM: a set of helper ORM utilities to make the interactions with SQL statements easier and safer.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="workflows"><a class="header" href="#workflows">Workflows</a></h1>
<p>The followings are sequence diagrams for internal EightFish.</p>
<h2 id="post-update-workflow"><a class="header" href="#post-update-workflow">Post (update) workflow</a></h2>
<p><img src="https://raw.githubusercontent.com/eightfish-org/eightfish_assets/master/ef_seq_write.svg" alt="" /></p>
<h2 id="query-read-workflow"><a class="header" href="#query-read-workflow">Query (read) workflow</a></h2>
<p><img src="https://raw.githubusercontent.com/eightfish-org/eightfish_assets/master/ef_seq_query.svg" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mvc-framework"><a class="header" href="#mvc-framework">MVC Framework</a></h1>
<p>EightFish embeds a thin MVC layer into it to make the programming life easier. If you come from the traditional Web developments, familiar with frameworks like Spring, Django, Flask, Express, Rocket and others, you will feel home when use EightFish.</p>
<p>In this page, we will use the <a href="https://github.com/eightfish-org/ef_example_simple_standalone">Simple Example</a> to demostrate.</p>
<h2 id="app-entry"><a class="header" href="#app-entry">App Entry</a></h2>
<p>An EightFish app is actually a <a href="https://developer.fermyon.com/spin/redis-trigger">Spin redis-triggered application</a>. The entry of this type of application looks like:</p>
<pre><code>#[redis_component]
fn on_message(message: Bytes) -&gt; Result&lt;()&gt; { }
</code></pre>
<p>You can look into the <a href="https://github.com/eightfish-org/ef_example_simple_standalone/blob/master/src/lib.rs#L31">lib.rs file</a> to learn the style.</p>
<p>The <code>on_message</code> function is just a boilerplate to comply with. In its body, we need to build the instance of our app, and mount it to <code>spin_worker::Worker</code>, and call <code>worker.work(message)</code> to process this incoming message.</p>
<p>Every time the message comes (from the redis channel), the EightFish App handler will process this message, and give response to somewhere (some caches, which is defined by components <code>spin_worker</code> and <code>http_gate</code> together, not the channel message comes from) in redis.</p>
<h2 id="app-instance"><a class="header" href="#app-instance">App Instance</a></h2>
<p>Every EightFish App should create an EightFish App instance, like:</p>
<pre><code>pub fn build_app() -&gt; EightFishApp {
    let mut sapp = EightFishApp::new();
    sapp.add_global_filter(Box::new(MyGlobalFilter))
        .add_module(Box::new(article::ArticleModule));

    sapp
}
</code></pre>
<p>The above function name is arbitrary, but should return the type of <code>EightFishApp</code>. In its body we create the instance of <code>EightFishApp</code>, mount global filter of the app and all modules implementing the application logic to this instance. </p>
<h2 id="global-filter"><a class="header" href="#global-filter">Global Filter</a></h2>
<p>The global filter of EightFish is for all incoming requests. Some actions (like cookie verifying, authentication, etc.) should be checked before any specific logic being executed. So we need this mechanism to tackle them.</p>
<pre><code>impl GlobalFilter for MyGlobalFilter {
    fn before(&amp;self, _req: &amp;mut Request) -&gt; EightFishResult&lt;()&gt; {
        Ok(())
    }

    fn after(&amp;self, _req: &amp;Request, _res: &amp;mut Response) -&gt; EightFishResult&lt;()&gt; {
        Ok(())
    }
}
</code></pre>
<p><code>GlobalFilter</code> is a trait defined by EightFish SDK. And there are two methods in it: <code>before()</code> and <code>after()</code>. The <code>before()</code> is used to process request ahead of any other biz logic code, and the <code>after()</code> is used to process the response after all biz logic but before responding to user, it's the last step we can write something to attach or modify information to the response.</p>
<h2 id="modules"><a class="header" href="#modules">Modules</a></h2>
<p>Every specific biz logic should be put into each specific module, and then mount these modules into the app instance described above. You can look into the <a href="https://github.com/eightfish-org/ef_example_simple_standalone/blob/master/src/article.rs">article.rs file</a> to get a concrete picture of the structure of a module.</p>
<p>First, you need to define a struct type, like: </p>
<pre><code>pub struct ArticleModule;
</code></pre>
<p>and implement the <code>Module</code> trait on it, to fill the router with some url endpoints:</p>
<pre><code>impl Module for ArticleModule {
    fn router(&amp;self, router: &amp;mut Router) -&gt; Result&lt;()&gt; {
        router.get(&quot;/article/:id&quot;, Self::get_one);
        router.post(&quot;/article/new&quot;, Self::new_article);
        router.post(&quot;/article/update&quot;, Self::update);
        router.post(&quot;/article/delete/:id&quot;, Self::delete);

        Ok(())
    }
}
</code></pre>
<p>The above snippet fills the url router <code>Router</code> by implementing the <code>fn router</code>, the router supports two kinds of methods: <code>get</code> and <code>post</code>, correspond to the HTTP GET and POST methods respectively.</p>
<p>Besides that, in the trait <code>Module</code>, we can implement the second level filters: <code>before()</code> and <code>after()</code>. These two filters apply on the url matches within this local module, not affecting other urls in other modules. So it is a kind of filter in module level. The <code>EightFish::Module</code> is <a href="https://github.com/eightfish-org/eightfish/blob/master/src/app.rs#L41">defined</a> as follow:</p>
<pre><code>pub trait EightFishModule: Sync + Send {
    /// module before filter, will be executed before handler
    fn before(&amp;self, _req: &amp;mut EightFishRequest) -&gt; Result&lt;()&gt; {
        Ok(())
    }

    /// module after filter, will be executed after handler
    fn after(&amp;self, _req: &amp;EightFishRequest, _res: &amp;mut EightFishResponse) -&gt; Result&lt;()&gt; {
        Ok(())
    }

    /// module router method, used to write router collection of this module here
    fn router(&amp;self, router: &amp;mut EightFishRouter) -&gt; Result&lt;()&gt;;
}
</code></pre>
<h2 id="url-handler"><a class="header" href="#url-handler">URL Handler</a></h2>
<p>The corresponding handlers are implemented onto the module struct, as a method of this struct, like:</p>
<pre><code>fn handler_name(req: &amp;mut Request) -&gt; Result&lt;Response&gt; {
</code></pre>
<p>Every url handler has unified function signature: a <code>req: &amp;mut Request</code> as parameter, and a <code>Result&lt;Response&gt;</code> as function returning.</p>
<p>In the handler function, you can process the request at the third level. </p>
<h2 id="middleware-mechanism"><a class="header" href="#middleware-mechanism">Middleware Mechanism</a></h2>
<p>In EightFish, middleware is just a normal function. It accepts the <code>req: &amp;mut Request</code> and return <code>Result&lt;()&gt;</code>.</p>
<pre><code>pub fn middleware_fn(req: &amp;mut Request) -&gt; Result&lt;()&gt; {
</code></pre>
<p>The middleware function could be placed in the global filter, module filter, or every handler function. This conduct a flexible three levels of middleware system.</p>
<h2 id="initial-globals"><a class="header" href="#initial-globals">Initial Globals</a></h2>
<p>There is a method on EightFishApp: <a href="https://github.com/eightfish-org/eightfish/blob/master/src/app.rs#L85"><code>init_global()</code></a>. You can put the global variables which should exist as long as the EightFish app's lifecycle in it. This is a mechanism for shared data between different requests.</p>
<p>In the provided closure, you need to insert your desired data into the extension part of the request, as follows:</p>
<pre><code>
let a_global = Arc::new(Mutex::new(..))

...
app.init_global(|req: &amp;mut Request| -&gt; Result&lt;()&gt; {
	req.ext_mut().insert(&quot;a_global&quot;, a_global);
})
...
</code></pre>
<h2 id="helper-macros"><a class="header" href="#helper-macros">Helper Macros</a></h2>
<p>EightFish designs some helper macros to improve the experience of logic coding, especially on interacting with SQL db.</p>
<p>EightFish provides a derived macro named <code>EightFishModel</code> for user's model.</p>
<p>For example, you just need to put this macro into the derive section above a model (struct) definition.</p>
<pre><code>#[derive(Debug, Clone, Serialize, Deserialize, EightFishModel, Default)]
pub struct Article {
    id: String,
    title: String,
    content: String,
    authorname: String,
}
</code></pre>
<p>After that, the struct <code>Article</code> will gain some powerful functionalities like:</p>
<pre><code>fn model_name() -&gt; String {}
fn field_names() -&gt; String {}
fn build_insert_sql() -&gt; String {}
fn from_row(row: Vec&lt;DbValue&gt;) -&gt; #ident {}
...
</code></pre>
<p>These functionalities make you write biz code easily, rapidly and happily.</p>
<p>You can refer to the detailed inline doc <a href="https://github.com/eightfish-org/eightfish/blob/master/eightfish-derive/src/eight_fish_model.rs#L85">here</a>.</p>
<h2 id="run-it"><a class="header" href="#run-it">Run it</a></h2>
<p>After all, switch into the app directory, and type:</p>
<pre><code>spin up
</code></pre>
<p>to run this app up.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="on-chain-service"><a class="header" href="#on-chain-service">On-chain Service</a></h1>
<p>EightFish is used to develop the decentralized application, so there are some important differences compared to traditional web framework.</p>
<p>For example, in EightFish app, we couldn't use the random function from your local environment, we MUST use the random data from the on-chain runtime. This will affect the generation of all models' id. </p>
<h2 id="random-string"><a class="header" href="#random-string">Random string</a></h2>
<p>EightFish offers a random string source out of box, this random string will change at every request. You can get the inner on-chain random string by:</p>
<pre><code>let id = req
    .ext()
    .get(&quot;random_str&quot;)
    .ok_or(anyhow!(&quot;id error&quot;))?
    .to_owned();
</code></pre>
<p>Please refer <a href="https://github.com/eightfish-org/ef_example_simple_standalone/blob/master/src/article.rs#L63">Simple Example</a> to get the context of above code.</p>
<h2 id="timestamp"><a class="header" href="#timestamp">Timestamp</a></h2>
<p>The timestamp has the same case with random string, we should use on-chain timestamp rather than local timestamp facility.</p>
<p>You can similarily retrieve the on-chain time by:</p>
<pre><code>let time = req
    .ext()
    .get(&quot;time&quot;)
    .ok_or(anyhow!(&quot;generate time failed&quot;))?
    .parse::&lt;i64&gt;()?;
</code></pre>
<p>The unit of the on-chain timestamp is micro second.</p>
<h2 id="others"><a class="header" href="#others">Others</a></h2>
<p>Generally speaking, you can't do any actions which would violate the state consensus with other EightFish nodes.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tinyorm"><a class="header" href="#tinyorm">TinyORM</a></h1>
<p>EightFish offers a set of basic ORM helper functions to make life easier when interacting with SQL.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="crud"><a class="header" href="#crud">CRUD</a></h1>
<h2 id="create"><a class="header" href="#create">Create</a></h2>
<p>You can use the method of <code>instance.build_insert()</code> to get an insert SQL statement from a model. For example:</p>
<pre><code>let article = Article {
    id,
    title,
    content,
    authorname,
};

let (sql_statement, sql_params) = article.build_insert();
_ = pg::execute(&amp;pg_addr, &amp;sql_statement, &amp;sql_params)?;
</code></pre>
<p>Please refer <a href="https://github.com/eightfish-org/ef_example_simple_standalone/blob/master/src/article.rs#L76">here</a> to checkout the context.</p>
<h2 id="update"><a class="header" href="#update">Update</a></h2>
<p>You can use the method of <code>instance.build_update()</code> to get an update SQL statement from a model. For example:</p>
<pre><code>let article = Article {
    id,
    title,
    content,
    authorname,
    ..old_article
};

let (sql, sql_params) = article.build_update();
_ = pg::execute(&amp;pg_addr, &amp;sql, &amp;sql_params)?;
</code></pre>
<p>Please refer <a href="https://github.com/eightfish-org/ef_example_simple_standalone/blob/master/src/article.rs#L123">here</a> to checkout the context.</p>
<h2 id="delete"><a class="header" href="#delete">Delete</a></h2>
<p>You can use the method of <code>model_name::build_delete(id)</code> to get a delete SQL statement from a model. For example:</p>
<pre><code>let id = params.get(&quot;id&quot;).ok_or(anyhow!(&quot;id error&quot;))?;

let (sql, sql_params) = Article::build_delete(id);
_ = pg::execute(&amp;pg_addr, &amp;sql, &amp;sql_params)?;
</code></pre>
<p>Please refer <a href="https://github.com/eightfish-org/ef_example_simple_standalone/blob/master/src/article.rs#L149">here</a> to checkout the context.</p>
<h2 id="get-by-id"><a class="header" href="#get-by-id">Get by Id</a></h2>
<p>You can use the method of <code>model_name::build_get_by_id()(id)</code> to get a simple query SQL statement from a model. For example:</p>
<pre><code>let article_id = params.get(&quot;id&quot;).ok_or(anyhow!(&quot;id error&quot;))?;

let (sql, sql_params) = Article::build_get_by_id(article_id);
let rowset = pg::query(&amp;pg_addr, &amp;sql, &amp;sql_params)?;
</code></pre>
<p>Please refer <a href="https://github.com/eightfish-org/ef_example_simple_standalone/blob/master/src/article.rs#L149">here</a> to checkout the context.</p>
<h2 id="convert-to-a-rust-type"><a class="header" href="#convert-to-a-rust-type">Convert to a Rust type</a></h2>
<p>You can use the method of <code>model_name::from_row(row)</code> to convert a row data from db to a specific Rust type (Model) instance. For example:</p>
<pre><code>let article = Article::from_row(row);
</code></pre>
<p>Please refer <a href="https://github.com/eightfish-org/ef_example_simple_standalone/blob/master/src/article.rs#L33">here</a> to checkout the context.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="complex-queries"><a class="header" href="#complex-queries">Complex Queries</a></h1>
<p>EightFish itself only supplies a set of basic sql builder helper function, if you need to construct complex sql statements, especially for query cases, you can use other sql builder crates to do it.</p>
<p>Ordinarily, we recommand to use crate <code>sql_builder</code> to do it.</p>
<p>Here are some examples:</p>
<p>nake sql.</p>
<pre><code>  let sql = SqlBuilder::select_from(&amp;GutpPost::model_name())
      .fields(&amp;GutpPost::fields())
      .order_desc(&quot;created_time&quot;)
      .limit(limit)
      .offset(offset)
      .sql()?;
  let rowset = pg::query(&amp;pg_addr, &amp;sql, &amp;[])?;
</code></pre>
<p>sql with parameters.</p>
<pre><code>  let sql = SqlBuilder::select_from(&amp;GutpPost::model_name())
      .fields(&amp;GutpPost::fields())
      .and_where_eq(&quot;subspace_id&quot;, &quot;$1&quot;)
      .order_desc(&quot;created_time&quot;)
      .limit(limit)
      .offset(offset)
      .sql()?;
  let sql_param = ParameterValue::Str(subspace_id);
  let rowset = pg::query(&amp;pg_addr, &amp;sql, &amp;[sql_param])?;
</code></pre>
<p>With <code>sql_builder::SqlBuilder</code> you can cook any deep of complicated sql sentence.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="limitations"><a class="header" href="#limitations">Limitations</a></h1>
<p>For the reason from inner mechanism of EightFish, currently you can use any ability of <code>JOIN</code> in sql statements.</p>
<p>That means, you can only do simple table queries right now!</p>
<p>We will dig to research how to loose this restriction in the future.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="todo"><a class="header" href="#todo">TODO</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="todo-1"><a class="header" href="#todo-1">TODO</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="todo-2"><a class="header" href="#todo-2">TODO</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="todo-3"><a class="header" href="#todo-3">TODO</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="todo-4"><a class="header" href="#todo-4">TODO</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="todo-5"><a class="header" href="#todo-5">TODO</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="todo-6"><a class="header" href="#todo-6">TODO</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="todo-7"><a class="header" href="#todo-7">TODO</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="todo-8"><a class="header" href="#todo-8">TODO</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="todo-9"><a class="header" href="#todo-9">TODO</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="todo-10"><a class="header" href="#todo-10">TODO</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-openweb-ecosystem"><a class="header" href="#the-openweb-ecosystem">The OpenWeb Ecosystem</a></h1>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
